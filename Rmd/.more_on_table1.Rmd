---
title: "Making Table 1 Descriptives Just Got Easy"
author: "Tyson Barrett"
date: 2016-08-27
output: md_document
---

As a follow up to my first post introducing the `furniture` package, I wanted to show a much more in depth demonstration of `table1()`'s capabilities and ease of use. To prep the data, I will also use another important function in the package--`washer()`--that allows easy cleaning of variables.

Similarly to my post on `furniture` we will use NHANES (see [my post here][furniture]). I have provided the data [here]( {{ site.url }}/blog/assets/Data/NHANES.zip). We will ask a different question relating to adolescent and early adulthood depression as it relates to chronic illness (specifically asthma for this post).

```{r, eval=FALSE}
setwd("~/the/path/tothe/directory/")    ## set it where your data is at
```

```{r}
setwd("~/Box Sync/GitHub/tysonbarrett-blog-rstats/assets/Data/")

library(purrr)      ## map()
library(plyr)       ## join_all()
library(dplyr)      ## %>% and a bunch of other stuff
library(foreign)    ## read.xport()
library(furniture)  ## table1 and washer

d <- list.files()[1:4] %>%                   ## gets list of files in working directory
  map(read.xport) %>%                   ## reads in each .xpt file
  join_all(by="SEQN", type="full") %>%  ## joins them by their ID
  setNames(tolower(names(.))) %>%       ## variables names are now lowercase
  select(seqn, riagendr, ridageyr, mcq010, mcq365a,     ## selects variables
         paq710, paq706, dpq010, dpq020, dpq030,
         dpq040, dpq050, dpq060, dpq070, dpq080,
         dpq090, dpq100) %>%
  filter(ridageyr < 30)                 ## only adolescents and children 
  
names(d) <- c("id", "gender", "age", "asthma", "loseweight",  ## renames the variables
              "tv_hrs", "act60", paste0("dep", 1:10))  

depvars = c(paste0("dep", 1:10))    ## for later use

## This is a simple function to apply to the data
##    If the max is 9 then 7 and 9 are placeholders for NA
##    If the max is 99 then 77 and 99 are placeholders
type1 = function(x){
  if (max(x, na.rm=TRUE) == 9){
    x = washer(x, 7, 9)
  } else if (max(x, na.rm=TRUE) == 99){
    x = washer(x, 77, 99)
  } else {
    x = x
  }
}

d[] <- map(d, type1)

## If TV is 8 then that meant no hours watched, changed to 0
d$tv_hrs <- washer(d$tv_hrs, 8, value=0)
              
```


## Table 1 Can Explore

The first thing that `table1()` can add to your data life is that it can help with exploratory data analysis. It can inform of relationships, missing patterns, and much more.

```{r}
## Explore with Table 1
table1(d, vars = depvars, splitby = "asthma", test = TRUE)
table1(d, vars = depvars, splitby = "loseweight", test = TRUE)
```

We quickly see that asthma does not appear to be related much to these depression items in this sample; however, that is not true for the "loseweight" variable. This variable consisted of a question asking the individual if a doctor had ever suggested that he/she needed to lose weight. This variable appears to be related to 5 or 6 of the 10 depression items. Specifically, the 10 items are:

1. `dep1` is "Have little interest in doing things"
2. `dep2` is "Feeling down, depressed, or hopeless"
3. `dep3` is "Trouble sleeping or sleeping too much"
4. `dep4` is "Feeling tired or having little energy"
5. `dep5` is "Poor appetite or overeating"
6. `dep6` is "Feeling bad about yourself"
7. `dep7` is "Trouble concentrating on things"
8. `dep8` is "Moving or speaking too slowly or too fast"
9. `dep9` is "Thought you would be better off dead"
10. `dep10` is "Difficulty these problems have caused"

So here, "loseweight" is related to "Poor appetite or overeating," "Feeling bad about yourself," and "High Difficulty from these problems." 

So now we can explore more aspects about these relationships. Maybe, instead of means and SD's, we want counts. `table1()` gives you counts when the variable is a factor.

```{r}
## Explore More
for (i in depvars){
  d[, i] = as.factor(d[, i])
}

table1(d, vars = depvars, splitby = "loseweight", test = TRUE)
```

Since the values in the depression scale are much more categorical (factors), this is much more informative. Here, we also have `dep1`, `dep4` and possibly `dep7` but no longer `dep10`. This suggests that "loseweight" is associated with "Having little interest in doing things," "Feeling tired or having little energy" as well as "Poor appetite or overeating" and "Feeling bad about yourself."

You can keep the missingness in the counts to better understand the distribution of missing.

```{r}
table1(d, vars = depvars, splitby = "loseweight", test = TRUE, NAkeep = TRUE)
```

Using just this one function, we have learned a lot about a handful of relationships. In conjunction with other summary and exploratory analysis functions, `table1()` can add to your ability to spot trends and patterns quickly.


## Table 1 Can Communicate

This is probably the best attribute of `table1()`. The output of the function was formatted to produce a table just like many academic "Table 1" tables in peer-reviewed journals. It makes the process of building the table much simpler--in fact, I'd say it makes it almost too easy. Just kidding, that's not really a thing when it comes to creating a table for a paper. Anything that makes it take less time and have fewer errors must be a good thing.

Once the data is cleaned, exclusions are made, and the questions of interest are established, `table1()` can help make a well-formatted, easily exportable, simply reproducible table. Here, we'll assume we've cleaned it and are now ready to report relationships.

```{r}
## Communicate
table1(d, vars = c("gender", "age", "dep1", "dep4", "dep5", "dep6"), 
       splitby = "loseweight", 
       test = TRUE, 
       format.output = "stars",
       splitby_labels = c("Loseweight", "No Loseweight"),
       var.names = c("Gender", "Age", "Little Interest", "Tired", "Appetite", "Feel Bad"))
```

We were able to print just stars (many journals like this) and we  can adjust the labels both on the stratifying variable (`splitby_labels`) and the variables (`var.names`).

## Table 1 Can Pipe

Finally, with the popularity of piping (`%>%` operator found in `dplyr` and `magrittr`), we've built in a feature to add `table1()` to a pipeline. It prints the table while not changing the data object so it can continue in the piping.

```{r}
## Communicate

d %>%
  table1(vars = c("gender", "age", "dep1", "dep4", "dep5", "dep6"), 
         splitby = "loseweight", 
         test = TRUE, 
         format.output = "stars",
         splitby_labels = c("Loseweight", "No Loseweight"),
         var.names = c("Gender", "Age", "Little Interest", "Tired", "Appetite", "Feel Bad"),
         piping = TRUE) %>%
  filter(age > 20 & age < 50) %>%
  table1(vars = c("gender", "age", "dep1", "dep4", "dep5", "dep6"), 
         splitby = "loseweight", 
         test = TRUE, 
         format.output = "stars",
         splitby_labels = c("Loseweight", "No Loseweight"),
         var.names = c("Gender", "Age", "Little Interest", "Tired", "Appetite", "Feel Bad"),
         piping = TRUE)
```

This example isn't incredibly useful, but hopefully it illustrates that it can flow easily within a pipe.

## Conclusion

I hope this helped demonstrate the utility of the function. Let me know if you'd like additional features or if you have found it useful in your work.

